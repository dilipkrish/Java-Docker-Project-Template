#------------------------------------------------------------------------------
# NOTE: This code was generated by a build tool using repo
# ({{projectTemplatesGithubCoordinates.user}}/{{projectTemplatesGithubCoordinates.repo}}#{{projectTemplatesGithubCoordinates.commitish}}).
#
# Changes to this file may cause incorrect behavior and will be lost if
# the code is regenerated. Please use the documentation provided
# in http://the-container-store.github.io/Gradle-Releaser/ to see
# how to regenerate this file based on your project settings.
#------------------------------------------------------------------------------
FROM {{baseBuildImage}} AS builder
WORKDIR /home/builder

# copy and download dependencies - this allows us to cache dependencies
COPY . /home/builder/

ARG VERSION

RUN ./gradlew --no-daemon buildReleaseCandidate stageDockerArtifacts -PexternallySuppliedVersion=$VERSION

# copy artifacts and package image
FROM {{baseExecImage}}

WORKDIR /home/app
COPY --from=builder /home/builder/build/docker/* ./

#
# Install prerequisites
#
RUN /home/app/yum-install-prerequisites.sh

USER {{runAsUser}}
EXPOSE {{exposePort}}

CMD consul-template \
        -template "/home/app/shim.sh:/home/app/shim.sh" \
        -exec-reload-signal=SIGUSR1 \
        -exec "/bin/bash -c \"trap '' SIGUSR1; /home/app/shim.sh\""