FROM {{baseBuildImage}} AS builder
WORKDIR /home/builder

# copy and download dependencies - this allows us to cache dependencies
COPY . /home/builder/

ARG VERSION

RUN ./gradlew --no-daemon downloadDependencies -PexternallySuppliedVersion=$VERSION

RUN ./gradlew --no-daemon buildReleaseCandidate stageDockerArtifacts -PexternallySuppliedVersion=$VERSION

# copy artifacts and package image
FROM {{baseExecImage}}

USER root
WORKDIR /home/app
COPY --from=builder /home/builder/build/docker/* ./

#
# Install prerequisites
#
RUN chown root /home/app/yum-install-prerequisites.sh \
&& chmod 700 /home/app/yum-install-prerequisites.sh \
&& /home/app/yum-install-prerequisites.sh \

USER {{runAsUser}}
EXPOSE {{exposePort}}

CMD consul-template \
        -exec-reload-signal=SIGUSR1 \
        -exec "/bin/bash -c \"trap '' SIGUSR1; /home/app/shim.sh\""
