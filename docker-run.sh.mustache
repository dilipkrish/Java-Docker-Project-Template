#!/usr/bin/env bash
set -e
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

if [ $# -eq 0 ]; then
  echo "Usage: $0 [image-id|repository:tag]"
  echo -e "Expecting the image id ${YELLOW}sha${NC} or ${YELLOW}repository:tag${NC}"
  exit 1
fi

if [ -z $DEPLOYMENT_ENVIRONMENT ]; then
  printf "Ensure you have the ${YELLOW}DEPLOYMENT_ENVIRONMENT${NC} variable is set\n"
  exit 1
fi

command -v vault >/dev/null 2>&1 || { printf >&2 "${YELLOW}vault${NC} (https://www.vaultproject.io) is ${YELLOW}required${NC}. Ensure it is installed\n"; exit 1; }

if [ ! -f ~/.vault-token ]; then
  echo "Please login to vault using ${YELLOW}vault login${NC}"
fi

docker run \
  -p 8080:8080 \
  -v $(pwd)/build/secrets:/etc/secrets/service/salesforce/salesforce_services_app:ro \
  -e DEPLOYMENT_ENVIRONMENT=$DEPLOYMENT_ENVIRONMENT \
  -e DEPLOYMENT_STACK=preview \
  -e VAULT_ADDR=https://vault.containerstore.com \
  -e VAULT_TOKEN=$(cat ~/.vault-token) \
{{#vault.environmentVariables}}
  -e {{name}}=$(vault read -field={{key}} {{secret}}) \
{{/vault.environmentVariables}}  
  $1
